{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "f95945e9",
   "metadata": {},
   "source": [
    "Here is the complete, production-grade solution designed for the NANSC Civil Aviation context. It integrates **Multi-Agent Orchestration**, **Custom Tools**, **Session Persistence**, **Observability**, and **Context Compaction**.\n",
    "\n",
    "### Cell 1: Environment Setup"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "42d468c5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Installs necessary libraries for Generative AI, RAG, and UI.\n",
    "\n",
    "%pip install -q -U google-generativeai langchain langchain-community langchain-google-genai chromadb gradio nest_asyncio pypdf pandas duckduckgo-search\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bc8707eb",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 1: Environment Setup & Imports\n",
    "# Installs necessary libraries.\n",
    "# NOTE: If you get import errors, Restart the Runtime/Kernel after this cell runs.\n",
    "\n",
    "\n",
    "import os\n",
    "import json\n",
    "import logging\n",
    "import asyncio\n",
    "import nest_asyncio\n",
    "import pandas as pd\n",
    "import gradio as gr\n",
    "from datetime import datetime\n",
    "from typing import List, Dict, Any\n",
    "from dataclasses import dataclass\n",
    "\n",
    "# Third-party imports\n",
    "import google.generativeai as genai\n",
    "from langchain_google_genai import GoogleGenerativeAIEmbeddings\n",
    "from langchain_text_splitters import RecursiveCharacterTextSplitter\n",
    "from langchain_community.document_loaders import PyPDFLoader\n",
    "from langchain_community.vectorstores import Chroma\n",
    "from langchain_community.tools import DuckDuckGoSearchRun\n",
    "\n",
    "# Apply asyncio patch for Jupyter/Colab environments\n",
    "nest_asyncio.apply()\n",
    "\n",
    "# --- API CONFIGURATION ---\n",
    "# PLEASE REPLACE WITH YOUR VALID GOOGLE API KEY\n",
    "genai.configure(api_key=os.environ[\"GOOGLE_API_KEY\"])\n",
    "\n",
    "print(\"‚úÖ Environment Setup Complete.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f114f87e",
   "metadata": {},
   "outputs": [],
   "source": [
    "print(os.environ[\"GOOGLE_API_KEY\"])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7555f803",
   "metadata": {},
   "source": [
    "\n",
    "### Cell 2: Layer 1 (State, Config & Observability)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1f51f294",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 2: Layer 1 - State, Configuration, and Observability\n",
    "\n",
    "# --- 1. CONFIGURATION ---\n",
    "@dataclass\n",
    "class SystemConfig:\n",
    "    app_name: str = \"NANSC_Intelligent_Console\"\n",
    "    persistence_dir: str = \"./nansc_data\"\n",
    "    model_name: str = \"gemini-2.5-flash\"\n",
    "\n",
    "    def __post_init__(self):\n",
    "        os.makedirs(self.persistence_dir, exist_ok=True)\n",
    "\n",
    "# --- 2. OBSERVABILITY (Metrics) ---\n",
    "@dataclass\n",
    "class TelemetryEvent:\n",
    "    timestamp: str\n",
    "    event_type: str\n",
    "    details: str\n",
    "\n",
    "class ObservabilityService:\n",
    "    def __init__(self):\n",
    "        self.events: List[TelemetryEvent] = []\n",
    "        self.metrics = {\"requests\": 0, \"tool_usage\": 0, \"errors\": 0}\n",
    "    \n",
    "    def log_event(self, event_type: str, details: str):\n",
    "        event = TelemetryEvent(datetime.now().strftime(\"%H:%M:%S\"), event_type, details)\n",
    "        self.events.append(event)\n",
    "        if event_type == \"ERROR\": self.metrics[\"errors\"] += 1\n",
    "        elif event_type == \"REQUEST\": self.metrics[\"requests\"] += 1\n",
    "        elif event_type == \"TOOL_USE\": self.metrics[\"tool_usage\"] += 1\n",
    "\n",
    "    def get_logs(self) -> str:\n",
    "        return \"\\n\".join([f\"[{e.timestamp}] [{e.event_type}] {e.details}\" for e in self.events[-15:]])\n",
    "\n",
    "# --- 3. SESSION MANAGER ---\n",
    "class SessionManager:\n",
    "    def __init__(self, config: SystemConfig):\n",
    "        self.filepath = os.path.join(config.persistence_dir, \"sessions.json\")\n",
    "    \n",
    "    def save_session(self, session_id: str, history: List[Dict]):\n",
    "        data = {}\n",
    "        if os.path.exists(self.filepath):\n",
    "            try:\n",
    "                with open(self.filepath, 'r') as f: data = json.load(f)\n",
    "            except: pass\n",
    "        \n",
    "        data[session_id] = {\"timestamp\": datetime.now().isoformat(), \"history\": history}\n",
    "        with open(self.filepath, 'w') as f: json.dump(data, f, indent=2)\n",
    "\n",
    "# Global Instances\n",
    "sys_config = SystemConfig()\n",
    "telemetry = ObservabilityService()\n",
    "session_manager = SessionManager(sys_config)\n",
    "\n",
    "# Logging\n",
    "logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')\n",
    "logger = logging.getLogger(\"NANSC_Core\")\n",
    "\n",
    "print(\"‚úÖ Layer 1 (State & Observability) Initialized.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2e5deac4",
   "metadata": {},
   "source": [
    "\n",
    "### Cell 3: Layer 2 (Knowledge & Tools)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3770b3a7",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 3: Layer 2 - Domain Logic, RAG Engine, and Tool Definitions\n",
    "\n",
    "# --- 1. DOMAIN LOGIC (Deterministic Tools) ---\n",
    "class ICAOTools:\n",
    "    AIRPORT_DB = {\n",
    "        \"HECA\": \"Cairo Intl (Egypt)\", \"HEBA\": \"Borg El Arab (Egypt)\",\n",
    "        \"OJAA\": \"Queen Alia (Jordan)\", \"EGLL\": \"London Heathrow (UK)\",\n",
    "        \"LFPG\": \"Paris CDG (France)\", \"KJFK\": \"JFK New York (USA)\"\n",
    "    }\n",
    "    \n",
    "    @staticmethod\n",
    "    def lookup_airport(icao_code: str) -> str:\n",
    "        \"\"\"Looks up an airport location by its 4-letter ICAO code.\"\"\"\n",
    "        code = icao_code.upper().strip()\n",
    "        result = ICAOTools.AIRPORT_DB.get(code, \"Unknown ICAO Code\")\n",
    "        telemetry.log_event(\"TOOL_USE\", f\"Airport Lookup: {code}\")\n",
    "        return result\n",
    "\n",
    "    @staticmethod\n",
    "    def bridge_aftn_to_amhs(aftn_address: str) -> str:\n",
    "        \"\"\"Converts legacy AFTN (8-char) to AMHS (X.400) format.\"\"\"\n",
    "        addr = aftn_address.upper().strip()\n",
    "        if len(addr) != 8: return \"Error: Address must be 8 chars.\"\n",
    "        \n",
    "        prmd_map = {\"HE\": \"EGYPT\", \"OJ\": \"JORDAN\", \"EG\": \"UK\", \"LF\": \"FRANCE\"}\n",
    "        prefix = addr[:2]\n",
    "        prmd = prmd_map.get(prefix, \"UNKNOWN\")\n",
    "        \n",
    "        x400 = f\"/C=XX/A=ICAO/P={prmd}/O={addr[:4]}/OU1={addr[4:]}\"\n",
    "        telemetry.log_event(\"TOOL_USE\", f\"Bridge Conversion: {addr} -> {x400}\")\n",
    "        return x400\n",
    "\n",
    "    @staticmethod\n",
    "    def web_search(query: str) -> str:\n",
    "        \"\"\"Searches the web for aviation definitions if internal knowledge fails.\"\"\"\n",
    "        try:\n",
    "            search = DuckDuckGoSearchRun()\n",
    "            res = search.run(query)\n",
    "            telemetry.log_event(\"TOOL_USE\", f\"Web Search: {query}\")\n",
    "            return res\n",
    "        except:\n",
    "            return \"Search unavailable.\"\n",
    "\n",
    "# --- 2. RAG ENGINE ---\n",
    "class RAGEngine:\n",
    "    def __init__(self, persistence_dir: str):\n",
    "        self.persist_dir = os.path.join(persistence_dir, \"chroma_db\")\n",
    "        self.embeddings = GoogleGenerativeAIEmbeddings(model=\"models/embedding-001\")\n",
    "        self.vector_store = None\n",
    "        self._init_db()\n",
    "\n",
    "    def _init_db(self):\n",
    "        try:\n",
    "            self.vector_store = Chroma(persist_directory=self.persist_dir, embedding_function=self.embeddings)\n",
    "        except Exception as e: logger.warning(f\"ChromaDB Init Note: {e}\")\n",
    "\n",
    "    def ingest_pdf(self, file_path: str) -> str:\n",
    "        try:\n",
    "            loader = PyPDFLoader(file_path)\n",
    "            docs = loader.load()\n",
    "            splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=100)\n",
    "            splits = splitter.split_documents(docs)\n",
    "            if self.vector_store:\n",
    "                self.vector_store.add_documents(splits)\n",
    "                telemetry.log_event(\"RAG_INGEST\", f\"Ingested {len(splits)} chunks\")\n",
    "                return f\"‚úÖ Ingested {len(splits)} chunks.\"\n",
    "            return \"‚ùå Vector Store not ready.\"\n",
    "        except Exception as e: return f\"Error: {e}\"\n",
    "\n",
    "    def query(self, question: str) -> str:\n",
    "        if not self.vector_store: return \"\"\n",
    "        docs = self.vector_store.similarity_search(question, k=3)\n",
    "        return \"\\n\".join([d.page_content[:500] for d in docs])\n",
    "\n",
    "rag_engine = RAGEngine(sys_config.persistence_dir)\n",
    "# Explicitly list tools for Gemini\n",
    "tools_list = [ICAOTools.lookup_airport, ICAOTools.bridge_aftn_to_amhs, ICAOTools.web_search]\n",
    "\n",
    "print(\"‚úÖ Layer 2 (Knowledge & Tools) Initialized.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e76f65d0",
   "metadata": {},
   "source": [
    "\n",
    "\n",
    "### Cell 4: Layer 3 (Agent) & Layer 4 (UI)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d11037e5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 4: Layer 3 (Agent) & Layer 4 (Robust Dashboard UI)\n",
    "\n",
    "# --- LAYER 3: AGENT ORCHESTRATOR ---\n",
    "class EnterpriseAgent:\n",
    "    def __init__(self):\n",
    "        # We explicitly list tools here to ensure Gemini knows about them\n",
    "        self.model = genai.GenerativeModel(\n",
    "            model_name=sys_config.model_name,\n",
    "            tools=tools_list, \n",
    "            system_instruction=\"\"\"\n",
    "            You are the NANSC Intelligent Operations Console Assistant.\n",
    "            \n",
    "            OPERATIONAL PROTOCOL:\n",
    "            1. DEFINITIONS: If the user asks \"What is...\", answer from your internal knowledge. \n",
    "               If unsure, use the 'web_search' tool.\n",
    "            2. CODES: If an ICAO code (4 letters) or AFTN address (8 letters) is detected, \n",
    "               ALWAYS use 'lookup_airport' or 'bridge_aftn_to_amhs' tools automatically.\n",
    "            3. PROCEDURES: If asked about rules/regs, refer to the RAG Context provided.\n",
    "            \n",
    "            Be professional, concise, and helpful.\n",
    "            \"\"\"\n",
    "        )\n",
    "        self.chat = self.model.start_chat(enable_automatic_function_calling=True)\n",
    "\n",
    "    async def process_message(self, message: str) -> str:\n",
    "        \"\"\"\n",
    "        Async handler to prevent 'Task attached to different loop' errors.\n",
    "        \"\"\"\n",
    "        # 1. RAG Context Injection (Simple Keyword Check)\n",
    "        rag_context = \"\"\n",
    "        if any(x in message.lower() for x in [\"procedure\", \"rule\", \"reg\", \"manual\", \"doc\"]):\n",
    "            rag_context = rag_engine.query(message)\n",
    "            if rag_context: \n",
    "                message = f\"Reference Info from Manuals:\\n{rag_context}\\n\\nUser Question: {message}\"\n",
    "        \n",
    "        try:\n",
    "            # 2. Async Generation\n",
    "            response = await self.chat.send_message_async(message)\n",
    "            telemetry.log_event(\"REQUEST\", \"Message processed successfully\")\n",
    "            \n",
    "            # 3. Session Persistence\n",
    "            hist_serialized = [{\"role\": p.role, \"parts\": [pt.text for pt in p.parts]} for p in self.chat.history]\n",
    "            session_manager.save_session(\"web_user\", hist_serialized)\n",
    "            \n",
    "            return response.text\n",
    "        except Exception as e:\n",
    "            telemetry.log_event(\"ERROR\", str(e))\n",
    "            return f\"‚ö†Ô∏è System Error: {str(e)}\"\n",
    "\n",
    "# --- LAYER 4: DASHBOARD UI ---\n",
    "agent = EnterpriseAgent()\n",
    "\n",
    "# 1. Chat Wrapper (Async)\n",
    "async def chat_wrapper(message, history):\n",
    "    if not message: return \"\"\n",
    "    return await agent.process_message(message)\n",
    "\n",
    "# 2. Tool Wrappers\n",
    "def batch_tool_wrapper(text_input, operation):\n",
    "    lines = [l.strip() for l in text_input.split('\\n') if l.strip()]\n",
    "    results = []\n",
    "    for line in lines:\n",
    "        if operation == \"Convert AFTN\":\n",
    "            res = ICAOTools.bridge_aftn_to_amhs(line)\n",
    "        else:\n",
    "            res = ICAOTools.lookup_airport(line)\n",
    "        results.append({\"Input\": line, \"Result\": res})\n",
    "    return pd.DataFrame(results)\n",
    "\n",
    "def ingest_wrapper(files):\n",
    "    if not files: return \"No files provided.\"\n",
    "    return \"\\n\".join([rag_engine.ingest_pdf(f.name) for f in files])\n",
    "\n",
    "def get_stats_wrapper():\n",
    "    return json.dumps(telemetry.metrics, indent=2), telemetry.get_logs()\n",
    "\n",
    "# 3. Layout Construction (Removed 'theme' arg for compatibility)\n",
    "with gr.Blocks(title=\"NANSC Ops Console\") as demo:\n",
    "    \n",
    "    # Header Section\n",
    "    with gr.Row():\n",
    "        with gr.Column():\n",
    "            gr.Markdown(\n",
    "                \"\"\"\n",
    "                # üì° NANSC Intelligent Operations Console\n",
    "                **Civil Aviation Telecommunications | AI-Powered Assistant**\n",
    "                \"\"\"\n",
    "            )\n",
    "    \n",
    "    # Main Dashboard Layout\n",
    "    with gr.Row():\n",
    "        \n",
    "        # LEFT COLUMN: Tools & Admin (Sidebar style)\n",
    "        with gr.Column(scale=1, min_width=300):\n",
    "            \n",
    "            with gr.Accordion(\"üõ†Ô∏è Batch Tools\", open=True):\n",
    "                gr.Markdown(\"Process multiple items at once.\")\n",
    "                b_in = gr.TextArea(lines=3, placeholder=\"HECAYFYX\\nOJAA\\nEGLL\", show_label=False)\n",
    "                b_op = gr.Radio([\"Convert AFTN\", \"Lookup Airport\"], value=\"Convert AFTN\", show_label=False)\n",
    "                b_btn = gr.Button(\"üöÄ Run Batch\", variant=\"primary\")\n",
    "                b_out = gr.Dataframe(headers=[\"Input\", \"Result\"], wrap=True)\n",
    "                b_btn.click(batch_tool_wrapper, inputs=[b_in, b_op], outputs=b_out)\n",
    "\n",
    "            with gr.Accordion(\"üìö Knowledge Base\", open=False):\n",
    "                gr.Markdown(\"Upload PDFs to RAG Engine.\")\n",
    "                f_up = gr.File(file_count=\"multiple\", file_types=[\".pdf\"])\n",
    "                up_btn = gr.Button(\"üì• Ingest\")\n",
    "                up_log = gr.Textbox(show_label=False, placeholder=\"Status...\")\n",
    "                up_btn.click(ingest_wrapper, inputs=[f_up], outputs=[up_log])\n",
    "                \n",
    "            with gr.Accordion(\"‚öôÔ∏è Telemetry\", open=False):\n",
    "                stat_btn = gr.Button(\"üîÑ Refresh\")\n",
    "                stat_json = gr.Code(language=\"json\", label=\"Metrics\", lines=5)\n",
    "                stat_log = gr.TextArea(label=\"System Logs\", lines=5)\n",
    "                stat_btn.click(get_stats_wrapper, outputs=[stat_json, stat_log])\n",
    "\n",
    "        # RIGHT COLUMN: Chat Interface\n",
    "        with gr.Column(scale=3):\n",
    "            gr.ChatInterface(\n",
    "                fn=chat_wrapper,\n",
    "                examples=[\n",
    "                    \"What is AMHS?\",\n",
    "                    \"Convert HECAYFYX to X.400\",\n",
    "                    \"Where is OJAA?\",\n",
    "                    \"Lookup EGLL\"\n",
    "                ],\n",
    "                title=\"Operations Assistant\",\n",
    "                description=\"Interact with the Enterprise Agent. Ask about definitions, convert addresses, or query manuals.\"\n",
    "            )\n",
    "\n",
    "print(\"üöÄ Launching NANSC Console...\")\n",
    "demo.launch(share=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "755bd153",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "datascience",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
